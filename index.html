<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collapsible Organization Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }
        
        /* Header */
        header { 
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 40px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        h2 { 
            margin: 0; 
            color: #ffffff; 
            font-size: 28px; 
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        
        #last-update {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .btn-refresh {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.5);
        }
        
        .btn-refresh:hover {
            background: rgba(34, 197, 94, 0.4);
        }

        /* Chart Area */
        #chart { 
            width: 100%; 
            height: 100vh;
            padding-top: 80px;
            background: radial-gradient(circle at 50% 50%, #ffffff 1px, transparent 1px) 0 0 / 30px 30px,
                        radial-gradient(circle at 50% 50%, #f0f0f0 1px, transparent 1px) 15px 15px / 30px 30px;
            overflow: hidden;
        }

        /* Node Styling */
        .node {
            cursor: pointer;
        }
        
        .node circle { 
            fill: #fff;
            stroke: #667eea;
            stroke-width: 3px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .node.has-children circle {
            fill: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .node:hover circle { 
            stroke: #764ba2;
            stroke-width: 4px;
            filter: drop-shadow(0 8px 12px rgba(102, 126, 234, 0.3));
            transform: scale(1.1);
        }
        
        .node text { 
            font-size: 12px; 
            font-weight: 600; 
            fill: #1f2937; 
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(255,255,255,0.9);
        }

        /* Link Styling */
        .link { 
            fill: none; 
            stroke: #475569; 
            stroke-width: 2px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        /* Collapsed indicator */
        .node.collapsed circle {
            fill: #fef3c7;
            stroke: #f59e0b;
            stroke-width: 4px;
        }
        
        /* Count badge for collapsed nodes */
        .count-badge {
            font-size: 10px;
            font-weight: bold;
            fill: #dc2626;
            pointer-events: none;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            opacity: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 2px solid #667eea;
            box-shadow: 0 15px 40px -5px rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 0;
            pointer-events: auto;
            min-width: 280px;
            max-width: 350px;
            z-index: 1000;
            transition: opacity 0.2s ease;
        }
        
        .tooltip-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            border-radius: 13px 13px 0 0;
        }
        
        .tooltip-header h4 { 
            margin: 0 0 5px 0; 
            font-size: 18px; 
            color: #ffffff;
            font-weight: 700;
        }
        
        .tooltip-header .subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin: 0;
        }
        
        .tooltip-body {
            padding: 15px 20px;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        
        .tooltip-row:last-child {
            border-bottom: none;
        }
        
        .tooltip-label {
            color: #6b7280;
            font-weight: 500;
        }
        
        .tooltip-value {
            color: #1f2937;
            font-weight: 600;
            text-align: right;
        }

        /* Loading indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 200;
        }
        
        .loading-text {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>

<header>
    <h2>ðŸ“Š Organization Hierarchy</h2>
    <div class="header-right">
        <div id="last-update">Loading...</div>
        <div class="controls">
            <button class="btn btn-refresh" onclick="manualRefresh()">ðŸ”„ Refresh Data</button>
            <button class="btn" onclick="expandAll()">Expand All</button>
            <button class="btn" onclick="collapseAll()">Collapse All</button>
            <button class="btn" onclick="resetZoom()">Reset View</button>
        </div>
    </div>
</header>

<div id="chart"></div>
<div id="tooltip" class="tooltip"></div>
<div id="loading" class="loading" style="display: none;">
    <div class="loading-text">Loading organization data...</div>
</div>

<script>
// =======================================================
// CONFIGURATION
// =======================================================
const SHEET_ID = "1lemebG36uQ9MlbKZC_O2H_ltJZZI8aXFlnWlMbD4MXA"; // Replace with your Google Sheet ID
const SHEET_NAME = "Sheet1"; // Replace with your sheet name

const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

// Chart dimensions
const width = window.innerWidth;
const height = window.innerHeight - 80;
const nodeRadius = 12;
const verticalSpacing = 100;
const horizontalSpacing = 180;

// Global variables
let root;
let svg, g, tree, zoom;
let tooltip;
let currentTransform = null; // Track current zoom/pan state

// =======================================================
// INITIALIZE
// =======================================================
function initialize() {
    tooltip = d3.select("#tooltip");
    
    // Add event listeners to tooltip to keep it visible
    tooltip.on("mouseenter", function() {
        clearTimeout(hideTimeout);
    })
    .on("mouseleave", function() {
        tooltip.style("opacity", 0);
    });
    
    // Create SVG
    svg = d3.select("#chart").append("svg")
        .attr("width", "100%")
        .attr("height", height)
        .style("display", "block");
    
    // Create zoom behavior
    zoom = d3.zoom()
        .scaleExtent([0.1, 3])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
            currentTransform = event.transform; // Save current state
        });
    
    svg.call(zoom);
    
    // Create main group
    g = svg.append("g")
        .attr("transform", `translate(${width / 2}, 50)`);
    
    // Create tree layout
    tree = d3.tree()
        .nodeSize([horizontalSpacing, verticalSpacing])
        .separation((a, b) => (a.parent === b.parent ? 1 : 1.2));
    
    // Load data
    loadAndRenderData();
}

// =======================================================
// DATA LOADING
// =======================================================
function loadAndRenderData() {
    document.getElementById('loading').style.display = 'block';
    
    d3.csv(SHEET_URL).then(data => {
        console.log("Data loaded:", data.length, "records");
        
        // Build hierarchy
        const hierarchyData = buildHierarchy(data);
        
        // Create root
        root = d3.hierarchy(hierarchyData);
        
        // Initialize with all collapsed except first level
        root.children.forEach(collapse);
        
        // Render
        update(root);
        
        // Center on root
        centerNode(root);
        
        // Update timestamp
        const now = new Date().toLocaleTimeString();
        document.getElementById('last-update').textContent = `Updated: ${now}`;
        document.getElementById('loading').style.display = 'none';
        
    }).catch(error => {
        console.error("Error loading data:", error);
        document.getElementById('last-update').textContent = `Error loading data`;
        document.getElementById('loading').style.display = 'none';
        alert("Error loading data from Google Sheets. Check console for details.");
    });
}

// Manual refresh function
function manualRefresh() {
    // Clear existing chart
    d3.select("#chart svg").remove();
    
    // Recreate SVG structure
    svg = d3.select("#chart").append("svg")
        .attr("width", "100%")
        .attr("height", height)
        .style("display", "block");
    
    svg.call(zoom);
    
    g = svg.append("g")
        .attr("transform", `translate(${width / 2}, 50)`);
    
    // Reset transform tracking
    currentTransform = null;
    
    // Load fresh data
    loadAndRenderData();
}

// =======================================================
// BUILD HIERARCHY
// =======================================================
function buildHierarchy(data) {
    // Create a map of all employees
    const employeeMap = new Map();
    
    data.forEach(row => {
        const name = row.Name ? row.Name.trim() : "";
        if (!name) return;
        
        employeeMap.set(name, {
            name: name,
            empid: row.Empid || "",
            department: row["Department Name"] || "",
            designation: row.Designation || "",
            grade: row.Grade || "",
            manager: row["Reporting Manager"] ? row["Reporting Manager"].trim() : "-",
            email: row.Email || "",
            mobile: row.Mobileno || "",
            doj: row.Doj || "",
            status: row.Employeestatus || "",
            children: []
        });
    });
    
    // Find top-level managers (those with "-" as manager)
    const topManagers = [];
    const assignedEmployees = new Set();
    
    employeeMap.forEach((employee, name) => {
        if (employee.manager === "-" || employee.manager === "") {
            topManagers.push(employee);
            assignedEmployees.add(name);
        }
    });
    
    console.log("Top managers:", topManagers.length);
    
    // Build parent-child relationships
    employeeMap.forEach((employee, name) => {
        if (employee.manager !== "-" && employee.manager !== "") {
            const manager = employeeMap.get(employee.manager);
            if (manager) {
                manager.children.push(employee);
                assignedEmployees.add(name);
            } else {
                console.warn("Manager not found:", employee.manager, "for employee:", name);
            }
        }
    });
    
    // Handle orphaned employees (those whose manager doesn't exist)
    const orphans = [];
    employeeMap.forEach((employee, name) => {
        if (!assignedEmployees.has(name)) {
            orphans.push(employee);
        }
    });
    
    if (orphans.length > 0) {
        console.warn("Orphaned employees (no valid manager):", orphans.length);
    }
    
    // Create virtual root
    const rootNode = {
        name: "Organization",
        isVirtual: true,
        children: topManagers
    };
    
    return rootNode;
}

// =======================================================
// UPDATE CHART
// =======================================================
function update(source) {
    // Compute the new tree layout
    const treeData = tree(root);
    const nodes = treeData.descendants();
    const links = treeData.links();
    
    // Update nodes
    const node = g.selectAll(".node")
        .data(nodes, d => d.data.name);
    
    // Enter new nodes
    const nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${source.x0 || 0},${source.y0 || 0})`)
        .on("click", (event, d) => {
            if (d.data.isVirtual) return;
            toggle(d);
            update(d);
        })
        .on("mouseover", showTooltip)
        .on("mouseout", hideTooltip);
    
    nodeEnter.append("circle")
        .attr("r", 1e-6)
        .style("fill", d => d._children ? "#fef3c7" : "#fff");
    
    // Add name label
    nodeEnter.append("text")
        .attr("dy", -18)
        .attr("text-anchor", "middle")
        .text(d => d.data.isVirtual ? "" : d.data.name)
        .style("fill-opacity", 1e-6);
    
    // Add count badge for collapsed nodes
    nodeEnter.append("text")
        .attr("class", "count-badge")
        .attr("dy", 5)
        .attr("text-anchor", "middle")
        .text(d => {
            if (d._children) {
                return `+${countDescendants(d)}`;
            }
            return "";
        })
        .style("fill-opacity", 1e-6);
    
    // Update existing nodes
    const nodeUpdate = nodeEnter.merge(node);
    
    nodeUpdate.transition()
        .duration(750)
        .attr("transform", d => `translate(${d.x},${d.y})`);
    
    nodeUpdate.select("circle")
        .attr("r", d => d.data.isVirtual ? 0 : nodeRadius)
        .style("fill", d => d._children ? "#fef3c7" : "#fff")
        .style("stroke", d => d._children ? "#f59e0b" : "#667eea")
        .attr("class", d => d._children ? "collapsed" : "");
    
    nodeUpdate.selectAll("text")
        .style("fill-opacity", d => d.data.isVirtual ? 0 : 1);
    
    nodeUpdate.select(".count-badge")
        .text(d => {
            if (d._children) {
                return `+${countDescendants(d)}`;
            }
            return "";
        });
    
    // Remove exiting nodes
    const nodeExit = node.exit().transition()
        .duration(750)
        .attr("transform", d => `translate(${source.x},${source.y})`)
        .remove();
    
    nodeExit.select("circle")
        .attr("r", 1e-6);
    
    nodeExit.selectAll("text")
        .style("fill-opacity", 1e-6);
    
    // Update links
    const link = g.selectAll(".link")
        .data(links, d => d.target.data.name);
    
    const linkEnter = link.enter().insert("path", "g")
        .attr("class", "link")
        .attr("d", d3.linkVertical()
            .x(d => source.x0 || 0)
            .y(d => source.y0 || 0));
    
    const linkUpdate = linkEnter.merge(link);
    
    linkUpdate.transition()
        .duration(750)
        .attr("d", d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y));
    
    link.exit().transition()
        .duration(750)
        .attr("d", d3.linkVertical()
            .x(d => source.x)
            .y(d => source.y))
        .remove();
    
    // Store old positions
    nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

// =======================================================
// HELPER FUNCTIONS
// =======================================================
function toggle(d) {
    if (d.children) {
        d._children = d.children;
        d.children = null;
    } else {
        d.children = d._children;
        d._children = null;
    }
}

function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

function expand(d) {
    if (d._children) {
        d.children = d._children;
        d.children.forEach(expand);
        d._children = null;
    }
}

function countDescendants(d) {
    let count = 0;
    if (d._children) {
        count = d._children.length;
        d._children.forEach(child => {
            count += countDescendants(child);
        });
    }
    return count;
}

function expandAll() {
    root.children.forEach(expand);
    update(root);
}

function collapseAll() {
    root.children.forEach(collapse);
    update(root);
}

function resetZoom() {
    svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity.translate(width / 2, 50));
}

function centerNode(source) {
    const scale = 0.8;
    const x = -source.x * scale + width / 2;
    const y = -source.y * scale + 100;
    
    svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
}

// =======================================================
// TOOLTIP
// =======================================================
let hideTimeout;

function showTooltip(event, d) {
    if (d.data.isVirtual) return;
    
    clearTimeout(hideTimeout);
    
    const data = d.data;
    const directReports = (d.children || d._children || []).length;
    const totalReports = countDescendants(d);
    
    let html = `
        <div class="tooltip-header">
            <h4>${data.name}</h4>
        </div>
        <div class="tooltip-body">
            <div class="tooltip-row">
                <span class="tooltip-label">Emp ID:</span>
                <span class="tooltip-value">${data.empid || 'N/A'}</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">Department:</span>
                <span class="tooltip-value">${data.department || 'N/A'}</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">Grade:</span>
                <span class="tooltip-value">${data.grade || 'N/A'}</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">Designation:</span>
                <span class="tooltip-value">${data.designation || 'N/A'}</span>
            </div>
    `;
    
    if (directReports > 0) {
        html += `
            <div class="tooltip-row">
                <span class="tooltip-label">Direct Reports:</span>
                <span class="tooltip-value">${directReports}</span>
            </div>
        `;
    }
    
    if (totalReports > 0) {
        html += `
            <div class="tooltip-row">
                <span class="tooltip-label">Total Team:</span>
                <span class="tooltip-value">${totalReports}</span>
            </div>
        `;
    }
    
    html += `</div>`;
    
    tooltip.html(html)
        .style("opacity", 1)
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px");
}

function hideTooltip() {
    hideTimeout = setTimeout(() => {
        tooltip.style("opacity", 0);
    }, 200);
}

// =======================================================
// AUTO-REFRESH - REMOVED (Now using manual refresh button)
// =======================================================

// Initialize on load
initialize();
</script>

</body>
</html>
